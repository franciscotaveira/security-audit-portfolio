/**
 * ðŸ”“ TESTES DE EXPLORAÃ‡ÃƒO - OWASP TOP 10
 * Cases 3-10: Injection, XSS, Access Control, etc.
 */

import { describe, test, expect } from "vitest";

// ============================================================================
// CASE 3: SQL INJECTION
// ============================================================================

describe("CASE 3: SQL Injection", () => {
    test("VulnerÃ¡vel: ConcatenaÃ§Ã£o de string em query", () => {
        const userInput = "'; DROP TABLE products; --";
        const vulnerableQuery = `SELECT * FROM products WHERE name = '${userInput}'`;

        console.log("ðŸ”´ SQL INJECTION EXPLOIT:");
        console.log("   Input:", userInput);
        console.log("   Query gerada:", vulnerableQuery);

        expect(vulnerableQuery).toContain("DROP TABLE");
    });

    test("VulnerÃ¡vel: ORDER BY injection", () => {
        const userInput = "id; DELETE FROM users";
        const vulnerableQuery = `SELECT * FROM products ORDER BY ${userInput}`;

        console.log("ðŸ”´ ORDER BY INJECTION:");
        console.log("   Query gerada:", vulnerableQuery);

        expect(vulnerableQuery).toContain("DELETE");
    });

    test("Seguro: Prepared statements protegem", () => {
        const userInput = "'; DROP TABLE products; --";
        // Em prepared statement, input vira parÃ¢metro, nÃ£o parte do SQL
        const safeQuery = "SELECT * FROM products WHERE name = $1";
        const params = [userInput];

        console.log("âœ… PREPARED STATEMENT SEGURO:");
        console.log("   Query:", safeQuery);
        console.log("   Params:", params);

        expect(safeQuery).not.toContain(userInput);
    });
});

// ============================================================================
// CASE 4: XSS
// ============================================================================

describe("CASE 4: XSS (Cross-Site Scripting)", () => {
    test("VulnerÃ¡vel: Script injection via comentÃ¡rio", () => {
        const maliciousInput = "<script>alert('XSS')</script>";
        const vulnerableHtml = `<div class="comment">${maliciousInput}</div>`;

        console.log("ðŸ”´ XSS EXPLOIT:");
        console.log("   Input:", maliciousInput);
        console.log("   HTML gerado:", vulnerableHtml);

        expect(vulnerableHtml).toContain("<script>");
    });

    test("VulnerÃ¡vel: Event handler injection", () => {
        const maliciousInput = '" onmouseover="alert(1)" data-x="';
        const vulnerableHtml = `<a href="${maliciousInput}">link</a>`;

        console.log("ðŸ”´ EVENT HANDLER INJECTION:");
        console.log("   HTML gerado:", vulnerableHtml);

        expect(vulnerableHtml).toContain("onmouseover");
    });

    test("Seguro: HTML escaping protege", () => {
        const escapeHtml = (s: string) => s
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        const maliciousInput = "<script>alert('XSS')</script>";
        const safeHtml = `<div class="comment">${escapeHtml(maliciousInput)}</div>`;

        console.log("âœ… HTML ESCAPING SEGURO:");
        console.log("   Resultado:", safeHtml);

        expect(safeHtml).not.toContain("<script>");
        expect(safeHtml).toContain("&lt;script&gt;");
    });
});

// ============================================================================
// CASE 5: BROKEN ACCESS CONTROL
// ============================================================================

describe("CASE 5: Broken Access Control", () => {
    test("VulnerÃ¡vel: IDOR - acesso a recurso de outro usuÃ¡rio", () => {
        // Atacante muda o ID na URL
        const attackerUrl = "/api/documents/other-user-doc-id";

        console.log("ðŸ”´ IDOR EXPLOIT:");
        console.log("   Atacante acessa:", attackerUrl);
        console.log("   Sem verificaÃ§Ã£o de ownership!");

        expect(attackerUrl).toContain("other-user");
    });

    test("VulnerÃ¡vel: Privilege escalation via body", () => {
        const maliciousBody = { userId: "admin-id", role: "admin" };

        console.log("ðŸ”´ PRIVILEGE ESCALATION:");
        console.log("   Body malicioso:", maliciousBody);

        expect(maliciousBody.role).toBe("admin");
    });

    test("VulnerÃ¡vel: Path traversal", () => {
        const maliciousFilename = "../../../etc/passwd";
        const vulnerablePath = `./uploads/${maliciousFilename}`;

        console.log("ðŸ”´ PATH TRAVERSAL:");
        console.log("   Atacante requisita:", vulnerablePath);

        expect(vulnerablePath).toContain("..");
    });
});

// ============================================================================
// CASE 6: SECURITY MISCONFIGURATION
// ============================================================================

describe("CASE 6: Security Misconfiguration", () => {
    test("VulnerÃ¡vel: Stack trace exposto", () => {
        const vulnerableError = {
            error: "Database connection failed",
            stack: "Error: at db.connect (/app/src/db.ts:45:12)",
            query: "SELECT * FROM users WHERE id = 1",
        };

        console.log("ðŸ”´ STACK TRACE EXPOSURE:");
        console.log("   Resposta de erro:", JSON.stringify(vulnerableError, null, 2));

        expect(vulnerableError.stack).toContain("/app/src/");
    });

    test("VulnerÃ¡vel: CORS aberto", () => {
        const vulnerableCors = {
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Methods": "*",
        };

        console.log("ðŸ”´ CORS MISCONFIGURATION:");
        console.log("   Headers:", vulnerableCors);

        expect(vulnerableCors["Access-Control-Allow-Origin"]).toBe("*");
    });

    test("VulnerÃ¡vel: Debug route em produÃ§Ã£o", () => {
        const debugRoutes = ["/debug/env", "/debug/memory", "/admin/logs"];

        console.log("ðŸ”´ DEBUG ROUTES EXPOSED:");
        debugRoutes.forEach(r => console.log("   ", r));

        expect(debugRoutes).toContain("/debug/env");
    });
});

// ============================================================================
// CASE 7: SENSITIVE DATA EXPOSURE
// ============================================================================

describe("CASE 7: Sensitive Data Exposure", () => {
    test("VulnerÃ¡vel: MD5 para senhas", () => {
        // MD5 Ã© rÃ¡pido demais - atacante pode fazer milhÃµes de tentativas/segundo
        const md5Hash = "5f4dcc3b5aa765d61d8327deb882cf99"; // "password"

        console.log("ðŸ”´ WEAK HASHING:");
        console.log("   MD5 de 'password':", md5Hash);
        console.log("   Pode ser quebrado em segundos!");

        expect(md5Hash.length).toBe(32);
    });

    test("VulnerÃ¡vel: Senha em log", () => {
        const logEntry = "Login attempt: email=user@test.com, password=secret123";

        console.log("ðŸ”´ PASSWORD IN LOGS:");
        console.log("   Log:", logEntry);

        expect(logEntry).toContain("password=");
    });

    test("VulnerÃ¡vel: API key na URL", () => {
        const vulnerableUrl = "https://api.example.com/data?key=sk-1234567890";

        console.log("ðŸ”´ API KEY IN URL:");
        console.log("   URL:", vulnerableUrl);
        console.log("   Fica em logs do servidor, histÃ³rico do browser!");

        expect(vulnerableUrl).toContain("key=");
    });
});

// ============================================================================
// CASE 8: SSRF
// ============================================================================

describe("CASE 8: SSRF (Server-Side Request Forgery)", () => {
    test("VulnerÃ¡vel: Acesso a metadata AWS", () => {
        const maliciousUrl = "http://169.254.169.254/latest/meta-data/";

        console.log("ðŸ”´ SSRF - AWS METADATA:");
        console.log("   URL maliciosa:", maliciousUrl);
        console.log("   Pode expor credentials da instÃ¢ncia EC2!");

        expect(maliciousUrl).toContain("169.254.169.254");
    });

    test("VulnerÃ¡vel: Acesso a serviÃ§o interno", () => {
        const maliciousUrl = "http://localhost:3000/admin/delete-all";

        console.log("ðŸ”´ SSRF - INTERNAL SERVICE:");
        console.log("   URL maliciosa:", maliciousUrl);

        expect(maliciousUrl).toContain("localhost");
    });

    test("Seguro: Whitelist de domÃ­nios", () => {
        const ALLOWED_DOMAINS = ["api.myapp.com", "cdn.myapp.com"];
        const testUrl = new URL("http://evil.com/steal");

        const isAllowed = ALLOWED_DOMAINS.includes(testUrl.hostname);

        console.log("âœ… DOMAIN WHITELIST:");
        console.log("   URL testada:", testUrl.href);
        console.log("   Permitida:", isAllowed);

        expect(isAllowed).toBe(false);
    });
});

// ============================================================================
// CASE 9: DoS
// ============================================================================

describe("CASE 9: DoS (Denial of Service)", () => {
    test("VulnerÃ¡vel: ReDoS - regex catastrÃ³fico", () => {
        // Este regex tem complexidade O(2^n) em certos inputs
        const catastrophicRegex = /^([a-zA-Z0-9]+)+@/;
        const maliciousInput = "a".repeat(25) + "!";

        console.log("ðŸ”´ ReDoS VULNERABILITY:");
        console.log("   Regex: /^([a-zA-Z0-9]+)+@/");
        console.log("   Input: 'a' x 25 + '!'");
        console.log("   Pode travar o servidor por minutos!");

        // NÃ£o executamos o teste real pois travaria
        expect(maliciousInput.length).toBe(26);
    });

    test("VulnerÃ¡vel: Sem paginaÃ§Ã£o", () => {
        const query = "SELECT * FROM users"; // 1 milhÃ£o de registros!

        console.log("ðŸ”´ MISSING PAGINATION:");
        console.log("   Query:", query);
        console.log("   Pode retornar milhÃµes de registros!");

        expect(query).not.toContain("LIMIT");
    });

    test("Seguro: Rate limiting aplicado", () => {
        const rateLimiter = {
            maxAttempts: 5,
            windowMs: 15 * 60 * 1000,
            currentAttempts: 6,
        };

        const isBlocked = rateLimiter.currentAttempts > rateLimiter.maxAttempts;

        console.log("âœ… RATE LIMITING:");
        console.log("   Max tentativas:", rateLimiter.maxAttempts);
        console.log("   Tentativas atuais:", rateLimiter.currentAttempts);
        console.log("   Bloqueado:", isBlocked);

        expect(isBlocked).toBe(true);
    });
});

// ============================================================================
// CASE 10: VULNERABLE DEPENDENCIES
// ============================================================================

describe("CASE 10: Vulnerable Dependencies", () => {
    test("VulnerÃ¡vel: Pacotes com CVEs conhecidas", () => {
        const vulnerablePackages = [
            { name: "lodash", version: "4.17.19", cve: "CVE-2021-23337" },
            { name: "minimist", version: "1.2.5", cve: "CVE-2021-44906" },
            { name: "qs", version: "6.5.2", cve: "CVE-2022-24999" },
        ];

        console.log("ðŸ”´ VULNERABLE DEPENDENCIES:");
        vulnerablePackages.forEach(p => {
            console.log(`   ${p.name}@${p.version} - ${p.cve}`);
        });

        expect(vulnerablePackages.length).toBeGreaterThan(0);
    });

    test("VulnerÃ¡vel: Dynamic import sem whitelist", () => {
        const userInput = "malicious-package";
        const vulnerableCode = `import("${userInput}")`;

        console.log("ðŸ”´ UNSAFE DYNAMIC IMPORT:");
        console.log("   CÃ³digo:", vulnerableCode);

        expect(vulnerableCode).toContain(userInput);
    });

    test("Seguro: Whitelist de plugins", () => {
        const ALLOWED_PLUGINS = ["analytics", "logging", "cache"];
        const requestedPlugin = "malicious";

        const isAllowed = ALLOWED_PLUGINS.includes(requestedPlugin);

        console.log("âœ… PLUGIN WHITELIST:");
        console.log("   Requisitado:", requestedPlugin);
        console.log("   Permitido:", isAllowed);

        expect(isAllowed).toBe(false);
    });
});

// ============================================================================
// RESUMO
// ============================================================================

describe("SUMMARY: OWASP Top 10 Coverage", () => {
    test("Todos os 10 casos cobertos", () => {
        const cases = [
            "Case 1: Broken Authentication (JWT)",
            "Case 2: Insecure Deserialization (UserService)",
            "Case 3: SQL Injection",
            "Case 4: XSS (Cross-Site Scripting)",
            "Case 5: Broken Access Control",
            "Case 6: Security Misconfiguration",
            "Case 7: Sensitive Data Exposure",
            "Case 8: SSRF",
            "Case 9: DoS (Denial of Service)",
            "Case 10: Vulnerable Dependencies",
        ];

        console.log("\nâœ… OWASP TOP 10 - TODOS OS CASES:");
        cases.forEach((c, i) => console.log(`   ${i + 1}. ${c}`));

        expect(cases.length).toBe(10);
    });
});
